import React, { useCallback, useMemo, useState } from "react";
import { useAtom } from "jotai";
import { FieldControl, FieldProps } from "@/views/form/builder";
import { DataRecord } from "@/services/client/data.types.ts";
import { useAtomValue } from "jotai/index";
import { Select, SelectIcon } from "@/components/select";
import { MaterialIcon } from "@axelor/ui/icons/material-icon";
import { ViewerInput, ViewerLink } from "@/views/form/widgets/string/viewer.tsx";
import { TnvedTreeProduct } from "@/views/form/widgets/custom-tree-product/tree-utils-product.tsx";

export function CustomTreeProduct(
  props: FieldProps<DataRecord> & { isSuggestBox?: boolean },
) {
  const {
    schema,
    valueAtom,
    widgetAtom,
    readonly: _readonly,
    invalid,
  } = props;

  const [value, setValue] = useAtom(valueAtom);
  const [openTree, setOpenTree] = useState(false);
  const { attrs } = useAtomValue(widgetAtom);
  const { focus, required, hidden, placeholder } = attrs as typeof attrs & { placeholder?: string };

  const readonly = _readonly;

  // –ò–∫–æ–Ω–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ä–µ–≤–∞
  const treeIcon: SelectIcon = {
    icon: <MaterialIcon icon="query_stats" />,
    onClick: () => setOpenTree(true),
  };

  if (hidden) return null;

  return (
    <FieldControl {...props}>
      {readonly ? (
        value ? (
          <ViewerLink onClick={() => {}}>{value.name}</ViewerLink>
        ) : (
          <ViewerInput name={schema.name} value="" />
        )
      ) : (
        <Select
          autoFocus={focus}
          required={required}
          invalid={invalid}
          autoComplete={false}
          fetchOptions={undefined}
          value={value}
          options={value ? [value] : []}
          optionKey={(rec) => rec.id}
          optionLabel={(rec) => rec.name || `#${rec.id}`}
          optionEqual={(a, b) => a?.id === b?.id}
          placeholder={placeholder}
          onChange={(val) => {
            console.log("üß© –í—ã–±—Ä–∞–Ω–æ –∏–∑ –¥–µ—Ä–µ–≤–∞:", val);
            setValue(val);
          }}
          icons={[treeIcon]}
          clearIcon={false}
          toggleIcon={false}
        />
      )}
<TnvedTreeProduct
  setValue={(val: DataRecord | null | undefined) => {
    if (!val) return;

    const isCategory = val.product !== undefined; // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    const hasProducts = Array.isArray(val.product) && val.product.length > 0;
    const hasChildren = val._children && val._children > 0; // –¥–æ—á–µ—Ä–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)

    // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä "–ø—É—Å—Ç–æ–π" –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (isCategory && !hasProducts && !hasChildren) {
      console.warn("‚ùå –ü—É—Å—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±—Ä–∞–Ω–∞, –æ—Ç–º–µ–Ω—è–µ–º:", val.name);
      return;
    }

    // ‚úÖ –ü—Ä–æ–¥—É–∫—Ç –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
    console.log("‚úÖ –í—ã–±—Ä–∞–Ω —ç–ª–µ–º–µ–Ω—Ç:", val.name);
    setValue(val);
  }}
  setOpenModal={setOpenTree}
  openModal={openTree}
/>


    </FieldControl>
  );
}
